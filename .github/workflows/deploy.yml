name: Deploy to EC2 with Apache

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1️⃣ Garantir Apache instalado e rodando (idempotente)
      - name: Ensure Apache is installed and running
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ec2-3-238-64-87.compute-1.amazonaws.com
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Atualiza pacotes
            sudo dnf update -y

            # Instala Apache somente se não existir
            if ! command -v httpd >/dev/null 2>&1; then
              echo "Apache não encontrado. Instalando..."
              sudo dnf install httpd -y
            else
              echo "Apache já instalado."
            fi

            # Inicia o serviço somente se não estiver ativo
            if ! systemctl is-active --quiet httpd; then
              echo "Iniciando Apache..."
              sudo systemctl start httpd
            else
              echo "Apache já está rodando."
            fi

            # Habilita no boot (não quebra se já estiver)
            sudo systemctl enable httpd

            # Garante permissão para deploy
            sudo chown -R ec2-user:ec2-user /var/www/html

      # 2️⃣ Deploy dos arquivos para o Apache
      - name: Deploy site to Apache
        uses: easingthemes/ssh-deploy@main
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          ARGS: "-rltgoDzvO --delete"
          SOURCE: "./"
          REMOTE_HOST: "ec2-34-201-16-3.compute-1.amazonaws.com"
          REMOTE_USER: "ec2-user"
          TARGET: "/var/www/html"
